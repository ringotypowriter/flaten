# flaten TDD è¿­ä»£è®¡åˆ’ï¼ˆå½“å‰æ—¥æœŸï¼š2025-11-24ï¼Œåœ°ç‚¹ï¼šUSï¼‰

> ç›®æ ‡ï¼šè¾“å…¥å«äººå£°çš„è§†é¢‘/éŸ³é¢‘ï¼Œè¾“å‡ºåªå«äººå£°ç‰‡æ®µçš„ `output.srt`ã€‚é‡‡ç”¨â€œå¾ªåºè§£é”â€çš„ TDDï¼Œå…ˆå†™çº¢ç¯æµ‹è¯•ï¼Œå†é€æ­¥å˜ç»¿ã€‚

## æ¨¡å—ä¸å½“å‰çŠ¶æ€ï¼ˆå·²å¯¹é½å½“å‰ä»£ç ï¼‰
- `subtitle_writer.zig` âœ… å·²å®ç°ï¼Œæµ‹è¯•ç»¿ã€‚è´Ÿè´£ `[]SubtitleItem` â†’ SRT å­—ç¬¦ä¸²ã€‚
- `cli_options.zig` âœ… å·²å®ç°ï¼Œæµ‹è¯•ç»¿ã€‚å®ŒæˆåŸºç¡€ CLI å‚æ•°è§£æï¼ˆ`--input/-i`ã€`--output/-o` ç­‰ï¼‰ã€‚
- `audio_segmenter.zig` ğŸš¨ ä»…æœ‰çº¢ç¯æµ‹è¯•ï¼Œæ ¸å¿ƒå®ç°æœªå†™ï¼ˆ`Error.Todo`ï¼‰ã€‚  
  - å·²æœ‰ä¸¤æ¡æµ‹è¯•çº¦æŸ VAD è¡Œä¸ºã€‚
- `ffmpeg_adapter.zig` âœ… å·²æœ‰å¯ç”¨å®ç°å’Œæµ‹è¯•ã€‚  
  - ä½¿ç”¨ `std.ArrayList` + `page_allocator` æ„é€  ffmpeg argvï¼Œæµ‹è¯•æ£€æŸ¥å…³é”®å‚æ•°æ˜¯å¦åŒ…å«ã€‚
- `model_manager.zig` âœ… æ–°å¢â€œæ¨¡å‹ç®¡ç†â€æ¨¡å—ï¼Œæµ‹è¯•ç»¿ã€‚  
  - è´Ÿè´£æ¨¡å‹ç›®å½•é€‰æ‹© + é¢„ä¸‹è½½ï¼ˆå¯æ³¨å…¥ fake downloaderï¼‰ã€‚
- `asr_sherpa.zig` âœ… å·²å®ç°åŸºç¡€å°è£…ï¼Œæµ‹è¯•ç»¿ã€‚  
  - æµ‹è¯•æ¨¡å¼ï¼ˆ`builtin.is_test`ï¼‰ä¸‹è¿”å› stub `"hello (stub)"`ï¼Œæ–¹ä¾¿ TDDã€‚  
  - æ­£å¸¸è¿è¡Œä¾èµ– `model_manager` è‡ªåŠ¨ç®¡ç†/ä¸‹è½½ sherpa æ¨¡å‹ã€‚
- `pipeline.zig` ğŸš¨ ç›®å‰æ˜¯ stubï¼Œå®ç°ç®€å•å›ºå®š SRTï¼Œæµ‹è¯•åªæ˜¯éªŒè¯åŒ…å« `HELLO` ä¸æ—¶é—´æˆ³ã€‚

## å½“å‰æµ‹è¯•è¡Œä¸ºæ¦‚è§ˆ
- VADï¼ˆ`audio_segmenter.zig`ï¼Œçº¢ç¯ï¼‰ï¼š  
  - ã€Œé™éŸ³â€“æœ‰å£°â€“é™éŸ³ã€3 ç§’æ³¢å½¢ï¼ŒæœŸæœ›æ£€æµ‹å‡º 1 æ®µçº¦ 1000â€“2000ms çš„ `SpeechSegment`ï¼ˆå…è®¸ Â±100ms è¯¯å·®ï¼‰ã€‚  
  - æ’å…¥ 50ms çš„é«˜èƒ½é‡ blip ä¸” `min_speech_ms = 200` æ—¶ï¼ŒæœŸæœ›ä¸äº§ç”Ÿä»»ä½•æ®µï¼ˆè¿‡æ»¤å™ªç‚¹ï¼‰ã€‚
- ffmpeg å‚æ•°æ‹¼è£…ï¼ˆ`ffmpeg_adapter.zig`ï¼Œç»¿ç¯ï¼‰ï¼š  
  - `build_ffmpeg_cmd` æ„é€ çš„å‘½ä»¤è¡Œåº”åŒ…å«ï¼š`ffmpeg -i <in> -vn -ac 1 -ar <rate> -f s16le -acodec pcm_s16le -` ç­‰å…³é”®ç‰‡æ®µã€‚
- æ¨¡å‹ç®¡ç†ï¼ˆ`model_manager.zig`ï¼Œç»¿ç¯ï¼‰ï¼š  
  - è‹¥é…ç½®ä¸­æä¾› `env_model_dir`ï¼Œ`ensureModelDir` ç›´æ¥è¿”å›è¯¥ç›®å½•ä¸”ä¸ä¼šè§¦å‘ä¸‹è½½ã€‚  
  - è‹¥ç›®æ ‡ç›®å½•ä¸å­˜åœ¨ model/tokens æ–‡ä»¶ï¼Œä¼šè°ƒç”¨æ³¨å…¥çš„ downloader åˆ›å»ºæ–‡ä»¶ï¼›ä¹‹åå†æ¬¡è°ƒç”¨ä¸ä¼šé‡å¤ä¸‹è½½ã€‚  
  - æ‰€æœ‰æµ‹è¯•åªåœ¨ä¸´æ—¶ç›®å½•ä¸‹æ“ä½œæ–‡ä»¶ï¼Œä¸è®¿é—®ç½‘ç»œã€‚
- ASR å°è£…ï¼ˆ`asr_sherpa.zig`ï¼Œç»¿ç¯ï¼‰ï¼š  
  - æµ‹è¯•ç”¨ä¾‹ä½¿ç”¨ `fake_wav` å­—èŠ‚ï¼Œè°ƒç”¨ `recognize`ï¼Œåªæ–­è¨€ç»“æœæ–‡æœ¬åŒ…å« `"hello"` æˆ– `"world"`ï¼›  
  - åœ¨ test build ä¸­å§‹ç»ˆèµ° stubï¼Œä¸ä¾èµ–çœŸå® C API æˆ–æ¨¡å‹ä¸‹è½½ã€‚
- Pipelineï¼ˆ`pipeline.zig`ï¼Œçº¢ç¯/å ä½ï¼‰ï¼š  
  - æµ‹è¯•ä¸­æ„é€ è™šæ‹Ÿ PCMã€`SpeechSegment` å’Œ `SegmentResult`ï¼Œå½“å‰å®ç°åªæ˜¯è¿”å›å›ºå®š SRTï¼›  
  - æ–­è¨€ SRT ä¸­åŒ…å« `"HELLO"` å’Œèµ·å§‹æ—¶é—´ `"00:00:00,000"`ï¼Œä¸ºåç»­çœŸæ­£æ¥çº¿ç•™å‡ºç©ºé—´ã€‚

### å•ç‹¬è¿è¡Œ asr_sherpa æµ‹è¯•çš„æ³¨æ„äº‹é¡¹

`src/asr_sherpa.zig` ä¾èµ–é¡¹ç›®è‡ªå¸¦çš„ sherpa-onnx å¤´æ–‡ä»¶å’ŒåŠ¨æ€åº“ï¼Œå®ƒä»¬é€šè¿‡ `build.zig` é‡Œçš„ `addIncludePath` / `addLibraryPath` æ³¨å…¥ã€‚  

- æ¨èçš„æµ‹è¯•å…¥å£ï¼šå§‹ç»ˆä½¿ç”¨ `zig build test`ï¼Œç”± `build.zig` ç»Ÿä¸€é…ç½® sherpa / ffmpeg çš„ `-I` / `-L` / `-l`ã€‚  
- å¦‚æœéœ€è¦å•ç‹¬è·‘è¿™ä¸ªæ–‡ä»¶çš„æµ‹è¯•ï¼ˆè€Œä¸æ˜¯èµ° `zig build test`ï¼‰ï¼Œå¿…é¡»æ‰‹åŠ¨è¡¥å…¨ C å¤´æ–‡ä»¶å’Œåº“è·¯å¾„ï¼Œä¾‹å¦‚ï¼š

  ```bash
  zig test src/asr_sherpa.zig \
    -I third_party/sherpa-onnx/v1.12.17/macos-universal/include \
    -L third_party/sherpa-onnx/v1.12.17/macos-universal/lib \
    -lsherpa-onnx-c-api -lonnxruntime
  ```

å¦åˆ™ç›´æ¥æ‰§è¡Œ `zig test src/asr_sherpa.zig` ä¼šå› ä¸ºæ‰¾ä¸åˆ° `sherpa-onnx/c-api/c-api.h` è€ŒæŠ¥ `C import failed`ã€‚

## æ¨èè¿­ä»£é¡ºåºï¼ˆåŸºäºç°çŠ¶çš„åç»­ TDD è·¯çº¿ï¼‰
1) å®ç° `audio_segmenter.detect_speech_segments`ï¼ˆèƒ½é‡é˜ˆå€¼ + æ—¶é—´é˜ˆå€¼ï¼‰ï¼Œå…ˆè®©ç°æœ‰ä¸¤æ¡ VAD æµ‹è¯•å˜ç»¿ã€‚  
2) æ”¶ç´§/æ‰©å±• `ffmpeg_adapter`ï¼šå¿…è¦æ—¶è¡¥å……å¤šé‡‡æ ·ç‡ã€å¤šå£°é“å‚æ•°æµ‹è¯•ï¼Œä»¥åŠèµ„æºå›æ”¶ç­–ç•¥ã€‚  
3) ä¸°å¯Œ `asr_sherpa`ï¼šåœ¨ä¿æŒ stub è¡Œä¸ºçš„å‰æä¸‹ï¼Œæ–°å¢â€œå¸¦çœŸå®æ¨¡å‹çš„é›†æˆæµ‹è¯•â€ï¼ˆå¯ç”¨ç¼–è¯‘ flag æ§åˆ¶æ˜¯å¦è¿è¡Œï¼‰ã€‚  
4) å®ç° `pipeline.transcribe_video_to_srt`ï¼š  
   - å…ˆç”¨å‡ VAD / å‡ ASR æ³¨å…¥ï¼Œå®ç°çº¯å†…å­˜çº§çš„ pipeline æµ‹è¯•ï¼›  
   - å†é€æ­¥æ¥ä¸ŠçœŸå® `audio_segmenter` + `asr_sherpa` + åç»­ ffmpeg æä¾›çš„ PCMã€‚  
5) CLI é›†æˆï¼ˆ`main.zig`ï¼‰ï¼š  
   - ç”¨ `cli_options` æ„é€  `PipelineConfig`ï¼Œè°ƒç”¨ pipeline è¾“å‡º SRTï¼›  
   - è¡¥å……å¯¹ç¼ºå¤± `--input`ã€è¾“å‡ºè·¯å¾„ä¸å¯å†™ç­‰é”™è¯¯è·¯å¾„çš„æµ‹è¯•ã€‚

## æœªæ¥æ‰©å±•ï¼ˆåç»­è¿­ä»£ï¼‰
- VAD æ”¹è¿›ï¼šåŠ å…¥é™éŸ³ paddingã€çŸ­æš‚åœé¡¿åˆå¹¶ã€å¤šæ®µå¹¶å‘ ASRã€‚
- å¹³å°æ”¯æŒï¼šffmpeg/sherpa ç›®æ ‡é”å®š Linux x86_64 ä¸ macOS arm64ï¼Œå¿…è¦æ—¶æ·»åŠ è·¨ç¼–è¯‘è„šæœ¬ã€‚
- æ€§èƒ½ä¸æ—¥å¿—ï¼šå¢åŠ å¹¶è¡Œåº¦ã€æ—¥å¿—çº§åˆ« flagã€å¯é€‰ä¿ç•™ä¸­é—´æ–‡ä»¶ã€‚
